name: docker
on:
  push:
    tags:
      - '*'
jobs:
  docker:
    name: build and push image to docker hub
    runs-on: ubuntu-latest
    steps:
    - name: Check out code 
      uses: actions/checkout@v1

    - name: buil and push 
      uses: docker/build-push-action@v1
      with:
        build_args: gitCommit=${{ github.sha }},semVer=${{ github.ref }}
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_TOKEN }}
        repository: ${{ github.repository }}
        tag_with_ref: true
        push: ${{ startsWith(github.ref, 'refs/tags/') }}
        
    - name: post to CI/CD webhook
      shell: bash
      env:
        TOKEN: ${{ secrets.K8_CI_TOKEN }}
        URL: ${{ secrets.K8_CI_URL }}
      run: |
       curl '"$URL"'' \
        -X POST \
        -H "Authorization: $TOKEN" \
        --data-binary '{"deploy_name":"set-img","container_name":"img","img":"${{ github.repository }}:${{ github.ref }}"}'

